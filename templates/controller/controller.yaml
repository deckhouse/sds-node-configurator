{{- /* Webhook TLS Certs Secret */ -}}
{{- $secretConfig := dict
  "valuesKey" "sdsNodeConfigurator"
  "webhookCertPath" "internal.customWebhookCert"
}}
{{ include "helm_lib_module_webhook_certs_secret" (list . $secretConfig) }}

{{- /* Controller Deployment */ -}}
{{- $leaderElectionEnvs := list
  (dict "name" "LEADER_ELECTION" "value" "true")
  (dict "name" "LEADER_ELECTION_NAMESPACE" "valueFrom" (dict "fieldRef" (dict "fieldPath" "metadata.namespace")))
  (dict "name" "LEADER_ELECTION_ID" "value" "sds-health-watcher-controller-leader-election")
}}

{{- $config := dict
  "valuesKey" "sdsNodeConfigurator"
  "webhookEnabled" true
  "webhookCertPath" "internal.customWebhookCert"
  "onMasterNode" true
  "podSecurityContext" "nobody"
  "controllerMetricsPort" 8080
  "additionalControllerEnvs" $leaderElectionEnvs
}}
{{ include "helm_lib_module_controller_manifests" (list . $config) }}

{{- /* Webhook Service with metrics port */ -}}
{{- $serviceConfig := dict
  "selectorApp" "controller"
  "additionalPorts" (list
    (dict "name" "metrics" "port" 8080 "targetPort" "metrics")
  )
}}
{{ include "helm_lib_module_webhook_service" (list . $serviceConfig) }}

{{- /* ValidatingWebhookConfiguration for LVMLogicalVolumeSnapshots */ -}}
{{- $llvsWebhookConfig := dict
  "name" "llvs-validation"
  "webhookName" "llvs-validation"
  "valuesKey" "sdsNodeConfigurator"
  "path" "/llvs-validate"
  "rules" (list (dict "apiGroups" (list "storage.deckhouse.io") "apiVersions" (list "v1alpha1") "operations" (list "*") "resources" (list "lvmlogicalvolumesnapshots") "scope" "Cluster"))
}}
{{ include "helm_lib_module_validating_webhook_configuration" (list . $llvsWebhookConfig) }}
