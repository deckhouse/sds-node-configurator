name: Build and push for dev

env:
  MODULES_REGISTRY: ${{ vars.DEV_REGISTRY }}
  CI_COMMIT_REF_NAME: ${{ github.ref_name }}
  MODULES_MODULE_NAME: ${{ vars.MODULE_NAME }}
  MODULES_MODULE_SOURCE: ${{ vars.DEV_MODULE_SOURCE }}
  MODULES_REGISTRY_LOGIN: ${{ vars.DEV_MODULES_REGISTRY_LOGIN }}
  MODULES_REGISTRY_PASSWORD: ${{ secrets.DEV_MODULES_REGISTRY_PASSWORD }}
  GOPROXY: ${{ secrets.GOPROXY }}
  SOURCE_REPO: ${{ secrets.SOURCE_REPO }}
  SOURCE_REPO_SSH_KEY: ${{ secrets.SOURCE_REPO_SSH_KEY }}
  BASE_IMAGES_VERSION: "v0.5.25"

on:
  #pull_request:
  # call from trivy_image_check.yaml, which in turn call from pull_request
  # https://stackoverflow.com/a/71489231
  workflow_call:
    inputs:
      svace_enabled:
        description: "Enable svace build and analyze"
        type: boolean
        required: false
  push:
    branches:
      - main

defaults:
  run:
    shell: bash

concurrency:
  group: "${{ github.workflow }}-${{ github.event.number || github.ref }}"
  cancel-in-progress: true

jobs:
  lint:
    runs-on: [self-hosted, regular]
    continue-on-error: true
    name: Lint
    steps:
      - uses: actions/checkout@v4
      - name: Copy openapi/values_ce.yaml to openapi/values.yaml
        run: |
          if [ -f openapi/values_ce.yaml ]; then
            cp -f openapi/values_ce.yaml openapi/values.yaml
          fi
      - uses: deckhouse/modules-actions/lint@main
        env:
          DMT_METRICS_URL: ${{ secrets.DMT_METRICS_URL }}
          DMT_METRICS_TOKEN: ${{ secrets.DMT_METRICS_TOKEN }}
      - name: Copy openapi/values_ee.yaml to openapi/values.yaml
        run: |
          if [ -f openapi/values_ee.yaml ]; then
            cp -f openapi/values_ee.yaml openapi/values.yaml
          fi
      - uses: deckhouse/modules-actions/lint@main
        env:
          DMT_METRICS_URL: ${{ secrets.DMT_METRICS_URL }}
          DMT_METRICS_TOKEN: ${{ secrets.DMT_METRICS_TOKEN }}

  set_edition:
    runs-on: [self-hosted, large]
    name: Set edition
    outputs:
      module_edition: ${{ steps.set-vars.outputs.MODULE_EDITION }}
    steps:
      - name: Get Pull Request Labels
        id: get-labels
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === "pull_request" || context.eventName === "pull_request_target" ) {
              const prNumber = context.payload.pull_request.number;
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });
              return labels.map(label => label.name);
            } else {
              return [];
            }
          result-encoding: string

      - name: Set vars
        id: set-vars
        run: |
          # Select edition for build, default ee
          if echo "${{ steps.get-labels.outputs.result }}" | grep -q "edition/ce"; then
            echo "MODULE_EDITION=ce" >> "$GITHUB_OUTPUT"
          else
            echo "MODULE_EDITION=ee" >> "$GITHUB_OUTPUT"
          fi

  dev_setup_build:
    runs-on: [self-hosted, large]
    name: Build and Push images
    needs: [set_edition]
    env:
      MODULE_EDITION: ${{needs.set_edition.outputs.module_edition}}
    steps:
      - name: Set vars for PR
        if: ${{ github.ref_name != 'main' }}
        run: |
          MODULES_MODULE_TAG="$(echo pr${{ github.ref_name }} | sed 's/\/.*//g')"
          echo "MODULES_MODULE_TAG=$MODULES_MODULE_TAG" >> "$GITHUB_ENV"
      - name: Set vars for main
        if: ${{ github.ref_name == 'main' }}
        run: |
          echo "MODULES_MODULE_TAG=${{ github.ref_name }}" >> "$GITHUB_ENV"
      - name: Print vars
        run: |
          echo MODULES_REGISTRY=$MODULES_REGISTRY
          echo CI_COMMIT_REF_NAME=$CI_COMMIT_REF_NAME
          echo MODULES_MODULE_NAME=$MODULES_MODULE_NAME
          echo MODULES_MODULE_SOURCE=$MODULES_MODULE_SOURCE
          echo MODULES_MODULE_TAG=$MODULES_MODULE_TAG
          echo MODULE_EDITION=$MODULE_EDITION

      - uses: actions/checkout@v4

      - name: Download base images and auth prepare
        run: |
          wget https://fox.flant.com/api/v4/projects/deckhouse%2Fbase-images/packages/generic/base_images/$BASE_IMAGES_VERSION/base_images.yml -O base_images.yml
          cat base_images.yml

      - uses: deckhouse/modules-actions/setup@v4
        with:
          registry: ${{ vars.DEV_REGISTRY }}
          registry_login: ${{ vars.DEV_MODULES_REGISTRY_LOGIN }}
          registry_password: ${{ secrets.DEV_MODULES_REGISTRY_PASSWORD }}
      - uses: deckhouse/modules-actions/build@v4
        with:
          module_source: "${{ vars.DEV_MODULE_SOURCE }}"
          module_name: ${{ vars.MODULE_NAME }}
          module_tag: ${{ env.MODULES_MODULE_TAG }}
          source_repo: ${{ secrets.SOURCE_REPO }}
          source_repo_ssh_key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
          svace_enabled: ${{ contains(github.event.pull_request.labels.*.name, 'analyze/svace') || github.event.inputs.svace_enabled }}
          svace_analyze_host: "${{ secrets.SVACE_ANALYZE_HOST }}"
          svace_analyze_ssh_user: "${{ secrets.SVACE_ANALYZE_SSH_USER }}"
          svace_analyze_ssh_key: "${{ secrets.SVACE_ANALYZE_SSH_PRIVATE_KEY }}"

  analyze_build:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'analyze/svace') || github.event.inputs.svace_enabled == 'true' }}
    name: Analyze build
    runs-on: [self-hosted, large]
    needs:
      - dev_setup_build
    steps:
      - uses: deckhouse/modules-actions/svace_analyze@v4
        with:
          project_group: ${{ github.event.repository.name }}
          ci_commit_ref_name: ${{ github.event.pull_request.head.ref || github.ref_name }}
          ci_commit_hash: ${{ github.sha }}
          svace_analyze_host: "${{ secrets.SVACE_ANALYZE_HOST }}"
          svace_analyze_ssh_user: "${{ secrets.SVACE_ANALYZE_SSH_USER }}"
          svacer_url: "${{ secrets.SVACER_URL }}"
          svacer_import_user: "${{ secrets.SVACER_IMPORT_USER }}"
          svacer_import_password: "${{ secrets.SVACER_IMPORT_PASSWORD }}"
          svace_analyze_ssh_private_key: "${{ secrets.SVACE_ANALYZE_SSH_PRIVATE_KEY }}"

  # E2E smoke тесты - запускаются после сборки при наличии лейбла e2e-smoke-test
  run_e2e_smoke_tests:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'e2e-smoke-test') }}
    name: Run E2E Smoke Tests
    runs-on: [self-hosted, regular]
    needs:
      - dev_setup_build
    env:
      E2E_NAMESPACE: "e2e-${{ vars.MODULE_NAME }}-pr${{ github.event.pull_request.number }}"
    steps:
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Clone sds-e2e repository
        run: |
          git clone https://github.com/deckhouse/sds-e2e.git /tmp/sds-e2e
          cd /tmp/sds-e2e
          echo "E2E repo cloned successfully"

      - name: Setup test environment
        run: |
          # Создаем директорию для credentials
          mkdir -p ~/.kube ~/.ssh
          
          # Сохраняем kubeconfig
          echo "${{ secrets.E2E_CLUSTER_KUBECONFIG }}" | base64 -d > ~/.kube/e2e-cluster.config
          
          # Сохраняем SSH ключ
          echo "${{ secrets.E2E_SSH_PRIVATE_KEY }}" > ~/.ssh/e2e_rsa
          chmod 600 ~/.ssh/e2e_rsa
          
          echo "Test environment prepared"

      - name: Run E2E tests
        id: run_tests
        run: |
          cd /tmp/sds-e2e/testkit_v2
          
          # Экспортируем переменные
          export LICENSE_KEY="${{ secrets.E2E_DECKHOUSE_LICENSE }}"
          
          # Определяем тесты для запуска в зависимости от модуля
          MODULE_NAME="${{ vars.MODULE_NAME }}"
          if [[ "$MODULE_NAME" == *"sds-node-configurator"* ]]; then
            TEST_PATTERN="./tests/00_healthcheck_test.go ./tests/01_sds_nc_test.go"
          elif [[ "$MODULE_NAME" == *"sds-replicated-volume"* ]]; then
            TEST_PATTERN="./tests/00_healthcheck_test.go ./tests/03_sds_lv_test.go"
          elif [[ "$MODULE_NAME" == *"data-export"* ]]; then
            TEST_PATTERN="./tests/00_healthcheck_test.go ./tests/base_test.go"
          else
            TEST_PATTERN="./tests/00_healthcheck_test.go"
          fi
          
          echo "Running tests: ${TEST_PATTERN}"
          echo "Namespace: ${E2E_NAMESPACE}"
          
          # Запускаем тесты
          go test -v -timeout 30m ${TEST_PATTERN} \
            -debug \
            -verbose \
            -sshhost "${{ secrets.E2E_SSH_HOST }}" \
            -sshkey ~/.ssh/e2e_rsa \
            -hypervisorkconfig ~/.kube/e2e-cluster.config \
            -skipoptional \
            -keepstate \
            -clustertype "Ubuntu 22 + Ubuntu 24 + Debian 11" \
            -namespace "${E2E_NAMESPACE}" \
            2>&1 | tee /tmp/e2e-test-output.log
          
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "TEST_EXIT_CODE=${TEST_EXIT_CODE}" >> $GITHUB_ENV
          exit ${TEST_EXIT_CODE}

      - name: Cleanup E2E resources
        if: always()
        run: |
          echo "Cleaning up E2E resources..."
          export KUBECONFIG=~/.kube/e2e-cluster.config
          
          # Удаляем namespace (удалит все ресурсы внутри: VD, VM и т.д.)
          kubectl delete namespace "${E2E_NAMESPACE}" --ignore-not-found=true --timeout=5m || true
          
          echo "Cleanup completed for namespace ${E2E_NAMESPACE}"

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-smoke-test-logs-${{ vars.MODULE_NAME }}-pr${{ github.event.pull_request.number }}
          path: /tmp/e2e-test-output.log
          retention-days: 7

      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = process.env.TEST_EXIT_CODE || '1';
            const status = exitCode === '0' ? '✅' : '❌';
            const statusText = exitCode === '0' ? 'passed' : 'failed';
            
            const comment = `## E2E Smoke Tests Results ${status}
            
            **Module:** ${{ vars.MODULE_NAME }}
            **Test Type:** Smoke tests
            **Namespace:** \`${process.env.E2E_NAMESPACE}\`
            **Status:** ${statusText}
            
            <details>
            <summary>View Details</summary>
            
            - **Workflow:** ${{ github.workflow }}
            - **Run ID:** ${{ github.run_id }}
            - **Commit:** ${{ github.sha }}
            - **Triggered by:** \`e2e-smoke-test\` label
            - **Duration:** ~10-15 minutes
            
            Tests were executed on the GitHub Actions runner and connected directly to the E2E cluster.
            
            **Download logs:**
            [View artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            </details>`;
            
            if (context.eventName === "pull_request" || context.eventName === "pull_request_target") {
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
